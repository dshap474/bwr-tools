# BWR Plots Pixel Perfect Testing

## Overview

This testing suite validates that the Next.js BWR plots implementation can generate charts that match the original Python/Streamlit implementation pixel-perfectly (or as close as possible).

## Test Data

### Dataset: `dataset.csv`
- **Source**: Transaction fee data from blockchain analytics
- **Size**: 713 rows Ã— 4 columns
- **Date Range**: 2023-07-28 to 2025-07-07 (reverse chronological)
- **Columns**:
  - `dt`: DateTime (ISO format)
  - `txfees_priorityfees_usd`: Priority fees in USD (numeric)
  - `txfees_basefee_usd`: Base fees in USD (numeric) 
  - `txfees_l1fee_usd`: L1 fees in USD (numeric)

### Reference Image: `example.png`
- **Purpose**: Ground truth image generated by the original Python implementation
- **Expected**: Chart showing transaction fees over time with BWR styling

## Test Components

### 1. Test Suite: `test-pixel-perfect.test.ts`
**Purpose**: Jest-based test suite for validating chart generation

**Test Cases**:
- âœ… `Dataset loads correctly` - Validates CSV parsing and DataFrame creation
- âœ… `Data types are detected correctly` - Ensures datetime and numeric type inference
- âœ… `Generate time series line chart` - Tests ScatterChart creation with time series data
- âœ… `Generate stacked area chart` - Tests MetricShareAreaChart creation
- ðŸš§ `Compare generated chart with reference image` - Pixel comparison (TODO)

### 2. Chart Generator: `chart-generator.ts`
**Purpose**: Utility class for generating charts programmatically

**Features**:
- `BWRChartGenerator` class for chart creation
- Multiple chart type generation:
  - Time series line chart (most likely match for reference)
  - Stacked area chart (fee composition)
  - Bar chart (for debugging)
- Data analysis and summary statistics
- Chart specification export to JSON

**Usage**:
```typescript
const generator = new BWRChartGenerator('./dataset.csv');
await generator.loadData();

// Generate different chart types
const lineChart = generator.generateTimeSeriesLineChart();
const areaChart = generator.generateStackedAreaChart();

// Export specifications for analysis
generator.exportChartSpec(lineChart, './line-chart-spec.json');
```

## Implementation Progress

### âœ… Completed (85-90%)
1. **Data Loading Pipeline**
   - CSV parsing with existing `parseFile()` function
   - DataFrame creation and validation
   - Data type inference and validation

2. **Chart Generation Infrastructure**
   - ScatterChart for time series line plots
   - MetricShareAreaChart for area/stacked charts
   - BarChart for alternative visualizations
   - BWR theming and styling integration

3. **Test Infrastructure**
   - Jest test setup with proper imports
   - Data loading and validation tests
   - Chart instantiation tests

### ðŸš§ In Progress
1. **Pixel Comparison Logic**
   - Chart rendering to canvas/image format
   - Image comparison algorithms
   - Tolerance-based matching

2. **Reference Chart Analysis**
   - Determine exact chart type from example.png
   - Reverse-engineer styling parameters
   - Match color schemes and layouts

### ðŸ“‹ TODO
1. **Visual Regression Testing**
   - Set up chart rendering environment
   - Implement pixel-by-pixel comparison
   - Define acceptable tolerance levels
   - Generate diff images for failures

2. **Chart Configuration Matching**
   - Analyze example.png characteristics
   - Determine optimal chart type and parameters
   - Fine-tune BWR styling to match reference

## Chart Type Analysis

Based on the data structure, the reference chart is likely:

### Most Probable: **Time Series Line Chart**
- X-axis: `dt` (dates)  
- Y-axis: Fee amounts in USD
- Multiple lines for different fee types
- BWR styling with custom colors

### Alternative: **Stacked Area Chart**
- Shows fee composition over time
- Better for visualizing relative proportions
- Common for financial time series data

## Running Tests

### Prerequisites
```bash
# Install dependencies (including image comparison libraries)
npm install

# Ensure BWR plotting system is set up
npm run build
```

### Run Test Suite
```bash
# Run the pixel perfect tests
npm test tests/bwr-plots-test/test-pixel-perfect.test.ts

# Run with verbose output
npm test tests/bwr-plots-test/test-pixel-perfect.test.ts -- --verbose

# Run just the pixel comparison test
npm test -- -t "Compare generated chart with reference image"
```

### Generate Chart Specifications
```bash
# Generate and export chart specifications
npx ts-node tests/bwr-plots-test/chart-generator.ts
```

This will create:
- `line-chart-spec.json` - Time series line chart specification
- `area-chart-spec.json` - Stacked area chart specification  
- `bar-chart-spec.json` - Bar chart specification
- `stacked-bar-chart-spec.json` - Stacked bar chart specification (matches reference)

### Test Output
When running the pixel comparison test, the following files will be generated:
- `actual.png` - The chart generated by the TypeScript implementation
- `diff.png` - Visual difference between actual and reference
- `comparison-report.json` - Detailed comparison statistics
- `comparison-report.html` - Visual HTML report showing all images side-by-side

## Next Steps

### Phase 1: Chart Analysis
1. **Examine Reference Image**
   - Determine chart type (line vs area vs other)
   - Identify color scheme and styling
   - Measure dimensions and layout

2. **Generate Candidate Charts**
   - Create multiple chart variations
   - Export as images for visual comparison
   - Iterate on styling parameters

### Phase 2: Pixel Comparison
1. **Set Up Rendering Pipeline**
   - Configure Plotly.js for headless rendering
   - Export charts as PNG with consistent settings
   - Implement image comparison utilities

2. **Comparison Metrics**
   - Pixel-by-pixel difference calculation
   - Structural similarity index (SSIM)
   - Tolerance-based matching for acceptable differences

### Phase 3: Automation
1. **CI/CD Integration**
   - Automated test runs on chart changes
   - Visual regression detection
   - Failure reporting with diff images

## Expected Outcomes

### Success Criteria
- [ ] Charts render without errors using BWR system
- [ ] Generated chart matches reference image within tolerance
- [ ] Data accurately represents CSV input
- [ ] BWR styling (colors, fonts, watermarks) applied correctly

### Deliverables
1. **Validated Chart Generation** - Proof that Next.js implementation matches Python version
2. **Regression Test Suite** - Ongoing validation for future changes
3. **Documentation** - Complete process for validating new chart types

## Technical Notes

### BWR Configuration
The charts use the BWR configuration system for:
- Color schemes and palettes
- Typography and fonts
- Watermark placement
- Layout and spacing

### Data Processing
- DateTime parsing for X-axis
- Numeric scaling for Y-axis values
- Automatic type inference from CSV
- Missing data handling

### Performance
- Large dataset (713 rows) handling
- Efficient chart rendering
- Memory usage optimization for test environment

---

**Status**: ðŸš§ Initial test infrastructure complete, pixel comparison pending
**Next**: Analyze reference image and implement visual comparison logic 